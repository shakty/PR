<!doctype html>
<title>Ultimatum Game</title>

<!-- Loading  nodeGame libraries and CSS -->
<script src="/socket.io/socket.io.js"></script> 
<script src="/javascripts/nodegame-full.js" charset="utf-8"></script>
<link rel='stylesheet' href='/stylesheets/player.css'></link>
<!-- end -->

<!-- Loading the Ultimatum game -->
<script src="./Ultimatum_wait.js" charset="utf-8"></script>
<!-- end -->

<body>
<div id="root">
  <h2 id="h2title">Please be patient. We are waiting for all the players to connect<span id="wait">...</span></h2>
</div>
<script>
  window.onload = function () {
	  
	  JSUS.sprintf = function (string, args, root) {
		  
		  var text, textNode, span, idx_start, idx_finish, idx_replace, idxs, spans = {};
		  
		  if (!args) {
		    return document.createTextNode(string);
		  }
		  
		  root = root || document.createElement('span');
		  
		  // Transform arguments before inserting them.
		  for (var key in args) {
		    if (args.hasOwnProperty(key)) {
		      
		      // pattern not found
		      if (idx_start === -1) continue;
		      
		      switch(key[0]) {
		      
		      case '%': // span
		        
		        idx_start = string.indexOf(key);
		        idx_replace = idx_start + key.length;
		        idx_finish = string.indexOf(key, idx_replace);
		        
		        if (idx_finish === -1) {
		          console.log('Error. Could not find closing key: ' + key);
		          continue;
		        }
		        
		        spans[idx_start] = key;
		        
		        break;
		      
		      case '@': // replace and sanitize
		        string = string.replace(key, escape(args[key]));
		        break;
		        
		      case '!': // replace and not sanitize
		        string = string.replace(key, args[key]);
		        break;
		        
		      default:
		        console.log('Identifier not in [!,@,%]: ' + key[0]);
		    
		      }
		    }
		  }
		  
		  // No span to creates
		  if (!JSUS.size(spans)) {
		    return document.createTextNode(string);
		  }
		  
		  // Re-assamble the string
		  
		  idxs = JSUS.keys(spans).sort(function(a,b){return a-b;});
		  idx_finish = 0;
		  for (var i = 0; i < idxs.length; i++) {
		    
		    // add span
		    key = spans[idxs[i]];
		    idx_start = string.indexOf(key);
		    
		    // add fragments of string
		    if (idx_finish !== idx_start-1) {
		      root.appendChild(document.createTextNode(string.substring(idx_finish, idx_start)));
		    }
		    
		    idx_replace = idx_start + key.length;
		    idx_finish = string.indexOf(key, idx_replace);
		    
		    span = W.getElement('span', null, args[key]);

		    text = string.substring(idx_replace, idx_finish);
		    
		    span.appendChild(document.createTextNode(text));
		    
		    root.appendChild(span);
		    idx_finish = idx_finish + key.length;
		  }
		  
		  // add the final part of the string
		  if (idx_finish !== string.length) {
		    root.appendChild(document.createTextNode(string.substring(idx_finish)));
		  }
		  
		  return root;
		};



		(function (node) {
		  
		  node.widgets.register('Chat', Chat);
		  
		  var J = node.JSUS,
		    W = node.window;
		  

		// ## Defaults
		
		Chat.modes = {
          MANY_TO_MANY: 'MANY_TO_MANY',
          MANY_TO_ONE: 'MANY_TO_ONE',
          ONE_TO_ONE: 'ONE_TO_ONE',
      };
		  
		  Chat.defaults = {};
		  Chat.defaults.id = 'Chat';
		  Chat.defaults.fieldset = { legend: 'Chat' };  
		  Chat.defaults.mode = Chat.modes.MANY_TO_MANY; 
		  Chat.defaults.textarea_id = 'chat_textarea';
		  Chat.defaults.chat_id = 'chat_chat';
		  Chat.defaults.chat_event = 'CHAT';
		  Chat.defaults.submit_id = 'chat_submit';
		  Chat.defaults.submit_text = 'chat';

		      
		// ## Meta-data
		  
		  
		  
		  Chat.name = 'Chat';
		  Chat.version = '0.3';
		  Chat.description = 'Offers a bi-diractional communication interface between players, or between players and the experimenter.';

		// ## Dependencies
		  
		  Chat.dependencies = {
		    JSUS: {}
		  };
		  
		  function Chat (options) {
		    this.id = options.id || Chat.id;
		    this.name = options.name || this.name;
		    this.buffer = [];
		    this.counter = 0;
		    
		    this.root = null;
		    
		    this.textarea_id = options.textarea_id || Chat.defaults.textarea_id;
		    this.chat_id = options.chat_id || Chat.defaults.chat_id;
		    this.submit_id = options.submit_id || Chat.defaults.submit_id;
		    
		    this.submit_text = options.submit_text || Chat.defaults.submit_text;
		  
		    this.chat_event = options.chat_event || Chat.defaults.chat_event;
		    
		    this.mode = options.mode || Chat.defaults.mode;

		    this.recipient = W.getRecipientSelector();
		    this.submit = W.getEventButton(this.chat_event, this.submit_text, this.submit_id);
		    this.textarea = W.getElement('textarea', this.textarea_id)
		    this.chat = W.getElement('div', this.chat_id);
		  }
		  
		  
		  Chat.prototype.append = function (root) {
		    this.root = root;
		    root.appendChild(this.chat);
		    root.appendChild(this.textarea);
		    root.appendChild(this.submit);
		    root.appendChild(this.recipient);
		    return root;
		  };
		  
		  Chat.prototype.getRoot = function () {
		    return this.root;
		  };
		  
		  Chat.prototype.readTA = function () {
		    var txt = this.textarea.value;
		    this.textarea.value = '';
		    return txt;
		  };
		  
		  Chat.prototype.listeners = function() {
		    var that = this;  
		    
		    node.on('UPDATED_PLIST', function() {
		      W.populateRecipientSelector(that.recipient, node.game.pl);
		    });
		    
		    node.on(this.chat_event, function () {
		      var msg = that.readTA();
		      var to = that.recipient.value;
		      var args = {
			        '%s': {
			          'class': 'chat_me',
			        },
			        '%msg': {
			          'class': 'chat_msg',
			        },
			        '!txt': msg,
		      };
		      J.sprintf('%sMe%s: %msg!txt%msg', args, that.chat);
		      W.writeln('', that.chat);
		      //node.say(this.chat_event, msg, to);
		    });
		    
		    node.onDATA(this.chat_event, function (msg) {
		    	var from = msg.from;
		      var args = {
			        '%s': {
			          'class': 'chat_others',
			        },
			        '%msg': {
			          'class': 'chat_msg',
			        },
			        '@txt': msg.data,
		          '!from': msg.from,
		      };
		      J.sprintf('%s!from%s: %msg@txt%msg', args, that.chat);
		      W.writeln('', that.chat);
		    });
		  }; 
		  
		  
		})(node);
		
		node.widgets.append('Chat', document.body);
	 
	  (function(){
		  var wait = document.getElementById('wait');
		  setInterval(function(){
		    if (wait.innerHTML !== '.....') {
		      wait.innerHTML = wait.innerHTML + '.';  
		    }
		    else {
		      wait.innerHTML = '..';
		    }
		  }, 1000)    
		})();
	  
	   // Player ID from Mturk
	   var mtid = JSUS.getQueryString('id');
	  
		// Create the Client
			
		 var conf = {
			name: "P_" + Math.floor(Math.random()*100),
			url: "/pr/wait",
			//verbosity: 10,
      io: {        
           reconnect: false
      },
      window: {
    	  promptOnleave: false,
      },
      player: {
          mtid: mtid,
      },
		};

		
    node.play(conf, new Ultimatum_wait());
    
	  
    
	}
</script>
</body>
