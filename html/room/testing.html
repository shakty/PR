<!doctype html>
<title>Test page</title>

<!-- JQUERY UI STARTS -->
<link type="text/css" href="./../../lib/jqueryui/css/ui-lightness/jquery-ui-1.8.20.custom.css" rel="Stylesheet" />
<script src="./../../lib/jqueryui/js/jquery-1.7.2.min.js" charset="utf-8"></script>
<script src="./../../lib/jqueryui/js/jquery-ui-1.8.20.custom.min.js" charset="utf-8"></script>
<!-- JQUERY UI ENDS -->

<!-- no Escape -->
<!-- <script src="/javascripts/noescape.js" charset="utf-8"></script> -->
<!-- no Escape ends -->


<link rel="stylesheet" type="text/css" href="./iframe.css">
<link rel="stylesheet" type="text/css" href="./../css/creation.css">
<link rel="stylesheet" type="text/css" href="./../css/exhibition.css">


<!--  CF -->
<script src="./../../CF/ChernoffFacesSimple.js" charset="utf-8"></script>
<script src="./../../CF/CFControls.js" charset="utf-8"></script>
<!-- CF ends -->

<body>
<div id="root">
  <h2 id="h2title">In this page we test if your browser has the necessary requirement to go ahead.</h2>
</div>
<div id="CFTEST">
	Below you will find an example of the user interface that of the game.
	Get familiar with it, and when you are ready to start the game, move the slider <em>Scale head horizontally</em> completely to the right.
	<p>
	If you can't visualize the page correctly, or if you are unable to complete the task, your browser is not supported.
	Please click the button "I cannot complete the task".
	<div id="returnBox">
  <button id="returnButton">I cannot complete the task</button>
	</p>
</div>
</div>

<script>

window.onload = function() {

  var node = parent.node,
	    J = JSUS = parent.JSUS,
			NDDB = parent.NDDB,
			W = parent.W;
			
			
			document.getElementById("returnButton").onclick = function(){
				node.emit('errors', ['Cannot complete the task']);
			};
			
			
			//node.conf.events.dumpEvents = true;

//	navigator.sayswho = (function(){
//	    var N= navigator.appName, ua= navigator.userAgent, tem;
//	    var M= ua.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
//	    if(M && (tem= ua.match(/version\/([\.\d]+)/i))!= null) M[2]= tem[1];
//	    M= M? [M[1], M[2]]: [N, navigator.appVersion,'-?'];
//	    return M;
//	   })();

//	console.log(navigator.sayswho);
//	console.log(navigator.userAgent);
	
	
	var testMeGeneral = function() {
    
    var errors = [];
    
    if ('undefined' === typeof $) {
      errors.push('jQuery not found');
    }
    
    if ('undefined' === typeof NDDB) {
      errors.push('NDDB not found');
    }
    
    if ('undefined' === typeof JSUS) {
      errors.push('JSUS not found');
    }
    
    if ('undefined' === typeof node.window) {
      errors.push('node.window not found');
    }
    
    if ('undefined' === typeof W) {
      errors.push('W not found');
    }
    
    if ('undefined' === typeof node.widgets) {
      errors.push('node.widgets not found');
    }
    
    if ('undefined' !== typeof NDDB) {
      try {
        var db = new NDDB();
      }
      catch(e) {
        errors.push('An error occurred manipulating the NDDB object: ' + e.message);
      }
    }
            
    return errors;
  };
  
  var testMyGame = function () {
		
    
     function addJQuerySliders(init) {
//       var sliders = $('#mainframe').contents().find( "#cf_controls div.ui-slider" );
//       sliders.each(function() {
			 
			   $( "#cf_controls div.ui-slider" ).each(function() {
             // read initial values from markup and remove that
             var settings = init[this.id];
             if (settings) {
               settings.slide = settings.change = function(e, ui) {
							
                 node.emit('CF_CHANGE');
								 
								 if (this.id === 'head_scale_x') {					
								 	  if ($(this).slider('value') === 2){
										  node.emit('DONE');
									     console.log('WORKS');		
										}
								 } 
								 
               };
               $( this ).slider(settings);
             }
           });
        };
    
      var errors = [];
    
      var wh = $(window).height();   // returns height of browser viewport
      var dh = $(document).height(); // returns height of HTML document
      var ww = $(window).width();   // returns width of browser viewport
      var dw = $(document).width(); // returns width of HTML document
    
		  var root = document.getElementById('CFTEST');
		  console.log(ww + ' x ' + wh);
		  console.log(typeof ww)
      if (wh < 768 || ww < 1024) {
				J.sprintf('%importantYour current resolution is too low: %important %res!wwx!wh%res.', {
					'%important': {
						className: 'important'
					},
					'%res': {
						className: 'res'
					},
					'!ww': ww,
					'!wh': wh
				}, root);
				W.writeln('The game requires a resolution of at least 1024x768 pixels on the screen', root);
				W.writeln('If you can, maximize the window screen and then reload the page. Otherwise click on "I cannot complete the task"', root);
        errors.push('Inappropriate resolution: ' + wh + ' ' + ww);
      }
      
			if (errors.length) {
				return errors;
			}
			
      try {
        
        var init_cf = node.widgets.widgets.ChernoffFaces.FaceVector.random();
        init_cf = CFControls.pinDownFeatures(init_cf);
				
				// set scale_head more to the left so that we can test the user
				// moving it to the right
				
				init_cf.head_scale_x = 0.3;
				
				console.log(init_cf);
        
        var init_sc = CFControls.normalizeFeatures(init_cf);
        
            var sc_options = {
              id: 'cf_controls',
              change: 'CF_CHANGE',
              features: init_sc,
            };
          
            var cfc = new CFControls(sc_options);
              
            var cf_options = { id: 'cf',
                       width: 500,
                       height: 500,
                       controls: cfc,
                       features: init_cf,
            };
            
           var creationDiv = document.getElementById('CFTEST');
           node.game.cf = node.widgets.append('ChernoffFacesSimple', creationDiv, cf_options);
           
           // Adding the jQuery sliders
           ////////////////////////////
           addJQuerySliders(init_sc);
      
			
      }
      catch(e) {
				console.log(e)
        errors.push('Error creating the ChernoffFacesSimple: ' + e.message);
      }
      
      
      return errors;
  };
	
	var err1 = testMeGeneral();
  var err2 = testMyGame();
      
  if (err1.length || err2.length) {
    node.emit('errors', err1.concat(err2));
  }
	
	node.on('errors', function(errors) {
		console.log('ERRORS!!!')
    JSUS.each(err1, function(e){
      console.log(e);
    });
    
    JSUS.each(err2, function(e){
      console.log(e);
    });
    
    node.set('errors', errors);
      
    node.window.loadFrame('/PR4/html/room/sorry.html');
	});
	
};


</script>
</body>